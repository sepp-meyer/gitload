{% extends "base.html" %}

{% block content %}
<h2>Ergebnisansicht</h2>

<ul class="nav nav-tabs" id="resultTab" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="text-tab" data-toggle="tab"
       href="#text" role="tab">Files als Text</a>
  </li>
  
  <li class="nav-item">
    <a class="nav-link" id="handover-tab" data-toggle="tab"
       href="#handover" role="tab">Markdown</a>
  </li>
  
  <li class="nav-item">
    <a class="nav-link" id="clean-tab" data-toggle="tab"
       href="#clean" role="tab">MD-no_comments</a>
  </li>

  <li class="nav-item">
    <a class="nav-link" id="func-tab" data-toggle="tab"
       href="#func" role="tab">Funktionsübersicht</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="import-tab" data-toggle="tab"
       href="#imports" role="tab">Imports</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="tree-tab" data-toggle="tab"
       href="#tree" role="tab">Codebaum</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="uml-tab" data-toggle="tab"
       href="#uml" role="tab">UML</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="errors-tab" data-toggle="tab"
       href="#errors" role="tab">Fehlerquellen</a>
  </li>
</ul>

<div class="tab-content border border-top-0 p-3" id="resultTabContent">
  <div class="tab-pane fade show active" id="text" role="tabpanel">
    <div class="position-relative">
      <button id="copyTextBtn" class="btn btn-sm btn-info"
              style="position:absolute; top:10px; right:10px;">
        Kopieren
      </button>
      <textarea id="outputText" class="form-control" rows="30" readonly
                style="padding-top:40px;">{{ combined_text }}</textarea>
    </div>
  </div>

  <div class="tab-pane fade" id="handover" role="tabpanel">
    <div class="position-relative">
      <div class="alert alert-secondary py-1 mb-2">
         <small>Dieses Format ist optimiert für LLMs (Repo-to-Text): Dateiname als Überschrift + Codeblock.</small>
      </div>
      <button id="copyHandoverBtn" class="btn btn-sm btn-info"
              style="position:absolute; top:45px; right:10px;">
        Kopieren
      </button>
      <textarea id="handoverText" class="form-control" rows="30" readonly
                style="padding-top:10px; font-family: monospace;">{{ handover_md }}</textarea>
    </div>
  </div>

  <div class="tab-pane fade" id="clean" role="tabpanel">
    <div class="position-relative">
      <div class="alert alert-secondary py-1 mb-2">
         <small>Kompakte Version: Kommentare und Docstrings in .py, .js, .html, .css entfernt.</small>
      </div>
      <button id="copyCleanBtn" class="btn btn-sm btn-info"
              style="position:absolute; top:45px; right:10px;">
        Kopieren
      </button>
      <textarea id="cleanText" class="form-control" rows="30" readonly
                style="padding-top:10px; font-family: monospace;">{{ handover_clean_md }}</textarea>
    </div>
  </div>

  <div class="tab-pane fade" id="func" role="tabpanel">
    {% if analysis_rows %}
      {% set cols = col_order or analysis_rows[0].keys() %}
      <div class="position-relative">
        <button id="copyFuncBtn" class="btn btn-sm btn-info"
                style="position:absolute; top:10px; right:10px;">
          Kopieren
        </button>
        <table class="table table-sm table-striped" id="funcTable">
          <thead>
            <tr>{% for c in cols %}<th>{{ c|capitalize }}</th>{% endfor %}</tr>
          </thead>
          <tbody>
            {% for r in analysis_rows %}
              <tr>{% for c in cols %}<td>{{ r.get(c, "") }}</td>{% endfor %}</tr>
            {% endfor %}
          </tbody>
        </table>
        <textarea id="funcCopyArea" style="position:absolute; left:-9999px;">{{ analysis_markdown }}</textarea>
      </div>
    {% else %}
      <p class="text-muted">Keine Funktionen gefunden.</p>
    {% endif %}
  </div>

  <div class="tab-pane fade" id="imports" role="tabpanel">
    {% if imports_rows %}
      <div class="position-relative">
        <button id="copyImportBtn" class="btn btn-sm btn-info"
                style="position:absolute; top:10px; right:10px;">
          Kopieren
        </button>
        <table class="table table-sm table-striped" id="importTable">
          <thead>
            <tr>
              <th>Datei</th><th>Zeile</th><th>Typ</th>
              <th>Modul</th><th>Name</th><th>Alias</th>
            </tr>
          </thead>
          <tbody>
            {% for imp in imports_rows %}
            <tr>
              <td>{{ imp.file }}</td>
              <td>{{ imp.lineno }}</td>
              <td>{{ imp.type }}</td>
              <td>{{ imp.module }}</td>
              <td>{{ imp.name or "" }}</td>
              <td>{{ imp.alias or "" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <textarea id="importCopyArea" style="position:absolute; left:-9999px;">{{ imports_copy }}</textarea>
      </div>
    {% else %}
      <p class="text-muted">Keine Imports gefunden.</p>
    {% endif %}
  </div>

  <div class="tab-pane fade" id="tree" role="tabpanel">
    {% if code_tree_str %}
      <div class="position-relative">
        <button id="copyTreeBtn" class="btn btn-sm btn-info"
                style="position:absolute; top:10px; right:10px;">
          Kopieren
        </button>
        <pre id="treeText" class="small">{{ code_tree_str }}</pre>
      </div>
    {% else %}
      <p class="text-muted">Kein Codebaum verfügbar.</p>
    {% endif %}
  </div>

  <div class="tab-pane fade" id="uml" role="tabpanel">
    {% if uml_code %}
      <div class="position-relative">
        <button id="copyUmlBtn" class="btn btn-sm btn-info"
                style="position:absolute; top:10px; right:10px;">
          Kopieren
        </button>
        <pre id="umlText" class="small">{{ uml_code }}</pre>
      </div>
    {% else %}
      <p class="text-muted">Keine UML-Daten vorhanden.</p>
    {% endif %}
  </div>

  <div class="tab-pane fade" id="errors" role="tabpanel">
    <div class="position-relative mb-2">
      <button id="copyErrorsBtn" class="btn btn-sm btn-info"
              style="position:absolute; top:0; right:0;">
        Kopieren
      </button>
      <textarea id="errorsCopyArea" class="d-none">
{% if alias_warnings %}
Alias-Konflikte bei imports
{% for w in alias_warnings %}
Datei: {{ w.file }}, Zeile: {{ w.lineno }}
from {{ w.module }} import {{ w.name }} as {{ w.alias }}
Hinweis: Alias-Import `{{ w.alias }}` für `{{ w.name }}` kann UML-Generator verwirren.
{% endfor %}
{% else %}
Keine Alias-Importe gefunden.
{% endif %}

{% if import_conflicts %}
Import-Konflikte und Konventionen
{% for c in import_conflicts %}
Datei: {{ c.file }}, Zeile: {{ c.lineno }}
{{ c.name }} aus: {% for mod in c.modules %}{{ mod }}{% if not loop.last %}, {% endif %}{% endfor %}
Hinweis: Symbol „{{ c.name }}“ wird aus unterschiedlichen Pfaden importiert.
{% endfor %}
{% endif %}
      </textarea>

      {% if alias_warnings %}
        <h5>Alias-Konflikte bei imports</h5>
        <ul class="list-group">
        {% for w in alias_warnings %}
          <li class="list-group-item">
            <strong>Datei:</strong> {{ w.file }}, 
            <strong>Zeile:</strong> {{ w.lineno }}<br>
            <code>from {{ w.module }} import {{ w.name }} as {{ w.alias }}</code><br>
            <small class="text-warning">
              Alias-Import `{{ w.alias }}` für `{{ w.name }}` kann UML-Generator verwirren. Am besten im Code auf Alias-import verzichten und Funktion direkt aufrufen.
            </small>
          </li>
        {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted">Keine Alias-Importe gefunden.</p>
      {% endif %}

      {% if import_conflicts %}
        <hr>
        <h5>Import-Konflikte und Konventionen</h5>
        <ul class="list-group">
          {% for c in import_conflicts %}
            <li class="list-group-item list-group-item-danger">
              <strong>Datei:</strong> {{ c.file }}, <strong>Zeile:</strong> {{ c.lineno }}<br>
              <code>{{ c.name }}</code> aus:
              {% for mod in c.modules %}<code>{{ mod }}</code>{% if not loop.last %}, {% endif %}{% endfor %}<br>
              <small class="text-danger">
                Gleiches Symbol „{{ c.name }}“ wird aus unterschiedlichen Pfaden importiert.
              </small>
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

<script>
  function copyFrom(idBtn, idSrc) {
    const btn = document.getElementById(idBtn);
    if (!btn) return;
    btn.addEventListener('click', () => {
      const el = document.getElementById(idSrc);
      const txt = el.value || el.innerText;
      navigator.clipboard.writeText(txt).then(() => {
        btn.textContent = "✔️ Kopiert!";
        setTimeout(() => btn.textContent = "Kopieren", 2000);
      });
    });
  }

  copyFrom('copyTextBtn',     'outputText');
  copyFrom('copyHandoverBtn', 'handoverText');
  copyFrom('copyCleanBtn',    'cleanText');    // <--- NEU für MD-no_comments
  copyFrom('copyFuncBtn',     'funcCopyArea');
  copyFrom('copyImportBtn',   'importCopyArea');
  copyFrom('copyTreeBtn',     'treeText');
  copyFrom('copyUmlBtn',      'umlText');
  copyFrom('copyErrorsBtn',   'errorsCopyArea');
</script>
{% endblock %}