<!-- app/templates/full_output.html -->
{% extends "base.html" %}

{% block content %}
<h2>Ergebnisansicht</h2>

<!-- Tabs ---------------------------------------------------------- -->
<ul class="nav nav-tabs" id="resultTab" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="text-tab" data-toggle="tab"
       href="#text" role="tab">Files als Text</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="func-tab" data-toggle="tab"
       href="#func" role="tab">Funktionsübersicht</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="import-tab" data-toggle="tab"
       href="#imports" role="tab">Imports</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="tree-tab" data-toggle="tab"
       href="#tree" role="tab">Codebaum</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="uml-tab" data-toggle="tab"
       href="#uml" role="tab">UML</a>
  </li>
  <!-- Neuer Tab für Fehlerquellen -->
  <li class="nav-item">
    <a class="nav-link" id="errors-tab" data-toggle="tab"
       href="#errors" role="tab">Fehlerquellen</a>
  </li>
</ul>

<div class="tab-content border border-top-0 p-3" id="resultTabContent">
  <!-- 1) Textansicht ---------------------------------------------- -->
  <div class="tab-pane fade show active" id="text" role="tabpanel">
    <div class="position-relative">
      <button id="copyTextBtn" class="btn btn-sm btn-info"
              style="position:absolute; top:10px; right:10px;">
        Kopieren
      </button>
      <textarea id="outputText" class="form-control" rows="30" readonly
                style="padding-top:40px;">{{ combined_text }}</textarea>
    </div>
  </div>

  <!-- 2) Funktionsübersicht --------------------------------------- -->
  <div class="tab-pane fade" id="func" role="tabpanel">
    {% if analysis_rows %}
      {% set cols = col_order or analysis_rows[0].keys() %}
      <div class="position-relative">
        <button id="copyFuncBtn" class="btn btn-sm btn-info"
                style="position:absolute; top:10px; right:10px;">
          Kopieren
        </button>
        <table class="table table-sm table-striped" id="funcTable">
          <thead>
            <tr>{% for c in cols %}<th>{{ c|capitalize }}</th>{% endfor %}</tr>
          </thead>
          <tbody>
            {% for r in analysis_rows %}
              <tr>{% for c in cols %}<td>{{ r.get(c, "") }}</td>{% endfor %}</tr>
            {% endfor %}
          </tbody>
        </table>
        <textarea id="funcCopyArea" style="position:absolute; left:-9999px;">{{ analysis_markdown }}</textarea>
      </div>
    {% else %}
      <p class="text-muted">Keine Funktionen gefunden.</p>
    {% endif %}
  </div>

  <!-- 3) Import-Übersicht ----------------------------------------- -->
  <div class="tab-pane fade" id="imports" role="tabpanel">
    {% if imports_rows %}
      <div class="position-relative">
        <button id="copyImportBtn" class="btn btn-sm btn-info"
                style="position:absolute; top:10px; right:10px;">
          Kopieren
        </button>
        <table class="table table-sm table-striped" id="importTable">
          <thead>
            <tr>
              <th>Datei</th><th>Zeile</th><th>Typ</th>
              <th>Modul</th><th>Name</th><th>Alias</th>
            </tr>
          </thead>
          <tbody>
            {% for imp in imports_rows %}
            <tr>
              <td>{{ imp.file }}</td>
              <td>{{ imp.lineno }}</td>
              <td>{{ imp.type }}</td>
              <td>{{ imp.module }}</td>
              <td>{{ imp.name or "" }}</td>
              <td>{{ imp.alias or "" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <textarea id="importCopyArea" style="position:absolute; left:-9999px;">{{ imports_copy }}</textarea>
      </div>
    {% else %}
      <p class="text-muted">Keine Imports gefunden.</p>
    {% endif %}
  </div>

  <!-- 4) Codebaum -------------------------------------------------- -->
  <div class="tab-pane fade" id="tree" role="tabpanel">
    {% if code_tree_str %}
      <div class="position-relative">
        <button id="copyTreeBtn" class="btn btn-sm btn-info"
                style="position:absolute; top:10px; right:10px;">
          Kopieren
        </button>
        <pre id="treeText" class="small">{{ code_tree_str }}</pre>
      </div>
    {% else %}
      <p class="text-muted">Kein Codebaum verfügbar.</p>
    {% endif %}
  </div>

  <!-- 5) UML-Ansicht --------------------------------------------- -->
  <div class="tab-pane fade" id="uml" role="tabpanel">
    {% if uml_code %}
      <div class="position-relative">
        <button id="copyUmlBtn" class="btn btn-sm btn-info"
                style="position:absolute; top:10px; right:10px;">
          Kopieren
        </button>
        <pre id="umlText" class="small">{{ uml_code }}</pre>
      </div>
    {% else %}
      <p class="text-muted">Keine UML-Daten vorhanden.</p>
    {% endif %}
  </div>

  <!-- 6) Fehlerquellen --------------------------------------------- -->
  <div class="tab-pane fade" id="errors" role="tabpanel">
    {% if alias_warnings %}
      <ul class="list-group">
      {% for w in alias_warnings %}
        <li class="list-group-item">
          <strong>Datei:</strong> {{ w.file }}, 
          <strong>Zeile:</strong> {{ w.lineno }}<br>
          <code>from {{ w.module }} import {{ w.name }} as {{ w.alias }}</code><br>
          <small class="text-warning">
            Alias-Import `{{ w.alias }}` für `{{ w.name }}` kann UML-Generator verwirren.
          </small>
        </li>
      {% endfor %}
      </ul>
    {% else %}
      <p class="text-muted">Keine Alias-Importe gefunden.</p>
    {% endif %}
  </div>
</div>

<!-- Bootstrap-JS -------------------------------------------------- -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

<script>
  function copyFrom(idBtn, idSrc) {
    const btn = document.getElementById(idBtn);
    if (!btn) return;
    btn.addEventListener('click', () => {
      const el = document.getElementById(idSrc);
      const txt = el.value || el.innerText;
      navigator.clipboard.writeText(txt).then(() => {
        btn.textContent = "✔️ Kopiert!";
        setTimeout(() => btn.textContent = "Kopieren", 2000);
      });
    });
  }
  copyFrom('copyTextBtn',   'outputText');
  copyFrom('copyFuncBtn',   'funcCopyArea');
  copyFrom('copyImportBtn', 'importCopyArea');
  copyFrom('copyTreeBtn',   'treeText');
  copyFrom('copyUmlBtn',    'umlText');
</script>
{% endblock %}
