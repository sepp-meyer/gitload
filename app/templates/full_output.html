<!-- app/templates/full_output.html -->
{% extends "base.html" %}

{% block content %}
<h2>Ergebnisansicht</h2>

<form method="post">
  <!-- Re-Submit Buttons -->
  <input type="hidden" name="selected_paths" value="">
  <div class="form-check mb-2">
    <input class="form-check-input" type="checkbox"
           id="with_analysis" name="with_analysis"
           {% if analyse_flag %}checked{% endif %}>
    <label class="form-check-label" for="with_analysis">
      Funktionsübersicht mit anzeigen
    </label>
  </div>
  <button class="btn btn-sm btn-primary mb-3">Ansicht neu erzeugen</button>
</form>

<!-- Tabs ---------------------------------------------------------- -->
<ul class="nav nav-tabs" id="resultTab" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="text-tab" data-toggle="tab"
       href="#text" role="tab">Files als Text</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="func-tab" data-toggle="tab"
       href="#func" role="tab">Funktionsübersicht</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="import-tab" data-toggle="tab"
       href="#imports" role="tab">Imports</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="tree-tab" data-toggle="tab"
       href="#tree" role="tab">Codebaum</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="uml-tab" data-toggle="tab"
       href="#uml" role="tab">UML</a>
  </li>
</ul>

<div class="tab-content border border-top-0 p-3" id="resultTabContent">
  <!-- 1) Textansicht ---------------------------------------------- -->
  <div class="tab-pane fade show active" id="text" role="tabpanel">
    <div class="position-relative">
      <button id="copyTextBtn" class="btn btn-sm btn-info"
              style="position:absolute; top:10px; right:10px;">
        Kopieren
      </button>
      <textarea id="outputText" class="form-control" rows="30" readonly
                style="padding-top:40px;">{{ combined_text }}</textarea>
    </div>
  </div>

  <!-- 2) Funktionsübersicht --------------------------------------- -->
  <div class="tab-pane fade" id="func" role="tabpanel">
    {% if analysis_rows %}
      {% set cols = col_order or analysis_rows[0].keys() %}
      <div class="position-relative">
        <button id="copyFuncBtn" class="btn btn-sm btn-info"
                style="position:absolute; top:10px; right:10px;">
          Kopieren
        </button>

        <table class="table table-sm table-striped" id="funcTable">
          <thead>
            <tr>{% for c in cols %}<th>{{ c|capitalize }}</th>{% endfor %}</tr>
          </thead>
          <tbody>
            {% for r in analysis_rows %}
              <tr>{% for c in cols %}<td>{{ r.get(c, "") }}</td>{% endfor %}</tr>
            {% endfor %}
          </tbody>
        </table>

        <!-- verstecktes <textarea> mit der Markdown-Version -->
        <textarea id="funcCopyArea" style="position:absolute; left:-9999px;">
{{ analysis_markdown }}
        </textarea>
      </div>
    {% else %}
      <p class="text-muted">Keine Analyse durchgeführt oder keine Funktionen gefunden.</p>
    {% endif %}
  </div>

  <!-- 3) Import-Übersicht ----------------------------------------- -->
  <div class="tab-pane fade" id="imports" role="tabpanel">
    {% if imports_rows %}
      <div class="position-relative">
        <button id="copyImportBtn" class="btn btn-sm btn-info"
                style="position:absolute; top:10px; right:10px;">
          Kopieren
        </button>

        <table class="table table-sm table-striped" id="importTable">
          <thead>
            <tr>
              <th>Datei</th><th>Zeile</th><th>Typ</th>
              <th>Modul</th><th>Name</th><th>Alias</th>
            </tr>
          </thead>
          <tbody>
            {% for imp in imports_rows %}
            <tr>
              <td>{{ imp.file }}</td>
              <td>{{ imp.lineno }}</td>
              <td>{{ imp.type }}</td>
              <td>{{ imp.module }}</td>
              <td>{{ imp.name or "" }}</td>
              <td>{{ imp.alias or "" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        <!-- verdecktes <textarea> für TSV-Copy -->
        <textarea id="importCopyArea" style="position:absolute; left:-9999px;">
{{ imports_copy }}
        </textarea>
      </div>
    {% else %}
      <p class="text-muted">Keine Imports erkannt (oder Analyse nicht aktiviert).</p>
    {% endif %}
  </div>

  <!-- 4) Codebaum -------------------------------------------------- -->
  <div class="tab-pane fade" id="tree" role="tabpanel">
    {% if code_tree_str %}
      <div class="position-relative">
        <button id="copyTreeBtn" class="btn btn-sm btn-info"
                style="position:absolute; top:10px; right:10px;">
          Kopieren
        </button>
        <pre id="treeText" class="small">{{ code_tree_str }}</pre>
      </div>
    {% else %}
      <p class="text-muted">Keine Analyse durchgeführt.</p>
    {% endif %}
  </div>

  <!-- 5) UML-Ansicht ------------------------------------------- -->
  <div class="tab-pane fade" id="uml" role="tabpanel">
    {% if uml_code %}
      <div class="position-relative">
        <button id="copyUmlBtn" class="btn btn-sm btn-info"
                style="position:absolute; top:10px; right:10px;">
          Kopieren
        </button>
        <pre id="umlText" class="small">{{ uml_code }}</pre>
      </div>
    {% else %}
      <p class="text-muted">Keine UML-Daten vorhanden.</p>
    {% endif %}
  </div>
</div>

<!-- Bootstrap-JS -------------------------------------------------- -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

<script>
  // Universal-Copy: helper
  function copyFrom(idBtn, idSrc, transform=null){
    const btn = document.getElementById(idBtn);
    if (!btn) return;
    btn.addEventListener('click', () => {
      let txt;
      const el = document.getElementById(idSrc);
      if (!el) return;
      if (el.tagName === 'TEXTAREA' || el.tagName === 'PRE') {
        txt = el.value || el.innerText;
      } else {
        txt = el.innerText;
      }
      if (transform) txt = transform(txt);
      navigator.clipboard.writeText(txt).then(() => {
        btn.textContent = "✔️ Kopiert!";
        setTimeout(() => btn.textContent = "Kopieren", 2000);
      });
    });
  }

  // Text-Tab
  copyFrom('copyTextBtn', 'outputText');

  // Funktions-Tab (Markdown)
  copyFrom('copyFuncBtn', 'funcCopyArea');

  // Imports-Tab (TSV)
  copyFrom('copyImportBtn', 'importCopyArea');

  // Codebaum-Tab
  copyFrom('copyTreeBtn', 'treeText');
  
  // UML-Tab
  copyFrom('copyUmlBtn', 'umlText');
</script>
{% endblock %}
